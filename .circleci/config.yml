version: 2.1  # CircleCI version

executors:
  terraform-executor:
    docker:
      - image: hashicorp/terraform:latest
    working_directory: ~/repo

jobs:
  terraform-apply:
    executor: terraform-executor
    steps:
      - checkout  # Pull the latest code from the repository

      # Install AWS CLI to allow Terraform to interact with AWS resources
      - run:
          name: Install AWS CLI
          command: |
            apk add --no-cache aws-cli
            aws --version  # Verify installation  

      # Initialize Terraform (fetch provider plugins and configure backend)
      - run:
          name: Terraform Init
          command: |
            cd terraform
            terraform init
            cd ..

      # Identify the latest modified `.tfvars` file from the last commit
      - run:
          name: Find Latest tfvars File
          command: |
            LATEST_FILE=$(git diff --name-only HEAD^ HEAD | grep '\.tfvars$' | tail -n 1)
            if [ -z "$LATEST_FILE" ]; then
              echo "No tfvars file changed, skipping apply."
              circleci-agent step halt  # Stop pipeline if no changes detected
              exit 0
            fi
            echo "Latest Terraform vars file: $LATEST_FILE"
            echo "export LATEST_FILE=$LATEST_FILE" >> $BASH_ENV  # Save it for the next steps

      # Validate that the tfvars file actually exists
      - run:
          name: Validate tfvars File Exists
          command: |
            source $BASH_ENV
            if [ ! -f "$LATEST_FILE" ]; then
              echo "‚ùå Error: The specified tfvars file '$LATEST_FILE' does not exist."
              ls -l $(dirname "$LATEST_FILE")  # List directory contents for debugging
              exit 1
            fi

      # Change directory to Terraform and run Terraform Plan
      - run:
          name: Terraform Plan
          command: |
            cd terraform
            terraform plan -var-file="../$LATEST_FILE"
            cd ..

      # Apply changes automatically without manual approval
      - run:
          name: Terraform Apply
          command: |
            cd terraform
            terraform apply -auto-approve -var-file="../$LATEST_FILE"
            cd ..

workflows:
  version: 2
  apply-on-merge:
    jobs:
      - terraform-apply:
          filters:
            branches:
              only: main  # This workflow triggers ONLY when merging into `main`
